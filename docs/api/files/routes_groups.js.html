<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>routes/groups.js - siyuan</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../logo.png" title="siyuan"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/圈子.html">圈子</a></li>
            
                <li><a href="../classes/活动.html">活动</a></li>
            
                <li><a href="../classes/用户.html">用户</a></li>
            
                <li><a href="../classes/管理员.html">管理员</a></li>
            
                <li><a href="../classes/话题.html">话题</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: routes/groups.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Created by Cam on 14-1-8.
 * @class 圈子
 */
var _ = require(&#x27;underscore&#x27;),
	Group = require(&#x27;../models/group&#x27;),
	GroupMember = require(&#x27;../models/group-membership&#x27;),
	errors = require(&#x27;../lib/errors&#x27;),
	Groups = Group.Set;

module.exports = function (app) {
	/**
	 * post /api/groups/find
	 * @method 圈子列表
	 * @param {Number} [id] 
	 * @param {String} [ownerid] 创建者id
	 * @param {String} [name] 圈子名
	 * @return {JSON}
	 * &lt;pre&gt;
	 *     {
  &quot;groups&quot;: [
    {
      &quot;id&quot;: 1,
      &quot;ownerid&quot;: 26,
      &quot;name&quot;: &quot;cab&quot;,
      &quot;description&quot;: &quot;Cavgob ija of bilzoro ded gibruzup mar mi pabigkum gegwubez je mig kegiso ufaica votojnuj zavo iki iw. Fefufi bawum gamokzap ni si nizifca con magi evubinek wawke cutero tan hanasboz wozes upvip su owicore. Ne lupwegsav medap ipajies pek ge jucrokub otihuham bi rafma peobizon teh&quot;,
      &quot;createtime&quot;: 1380494258000,
      &quot;avatar&quot;: null,
      &quot;members&quot;: [
        {
          &quot;userid&quot;: 24,
          &quot;isowner&quot;: 0,
          &quot;isadmin&quot;: 0,
          &quot;remark&quot;: &quot;jumefojek&quot;,
          &quot;profile&quot;: {
            &quot;id&quot;: 24,
            &quot;username&quot;: &quot;mifi_94&quot;,
            &quot;regtime&quot;: 1385861668000,
            &quot;isonline&quot;: 0,
            &quot;profile&quot;: {
              &quot;email&quot;: &quot;hipignoz@inojuptuw.com&quot;,
				 &quot;nickname&quot;: &quot;Angelina Swanson&quot;,
				 &quot;name&quot;: &quot;Savannah Patterson&quot;,
				 &quot;gender&quot;: &quot;f&quot;,
				 &quot;age&quot;: 53,
				 &quot;grade&quot;: 1978,
				 &quot;university&quot;: &quot;Tonadde University&quot;,
				 &quot;major&quot;: &quot;Onpuval&quot;
				 },
				 &quot;avatar&quot;: &quot;/avatars/24.jpg&quot;
				 }
				 },
				 ...
				}
	        ]
	    },
	    ...
	  ]
	 }
	 &lt;/pre&gt;
	 */
	app.get(&#x27;/api/groups/find&#x27;, function (req, res, next) {
		var query = req.query,
			accepts = [&#x27;id&#x27;, &#x27;ownerid&#x27;, &#x27;name&#x27;];
		Groups.forge().query(function (qb) {
			_.each(accepts, function (k) {
				if (k in query) {
					qb.where(k, query[k]);
				}
			});
		}).query(&#x27;offset&#x27;, query[&#x27;offset&#x27;])
			.query(&#x27;limit&#x27;, query[&#x27;limit&#x27;])
			.fetch()
			.then(function (groups) {
				groups.mapThen(function (group) {
					return group.load([&#x27;members&#x27;, &#x27;members.profile&#x27;, &#x27;members.profile.profile&#x27;]);
				}).then(function(groups) {
						next({
							groups: groups
						});
					});
			}).catch(next);
	});

	/**
	 * post /api/groups/create
	 * @method 创建圈子
	 * @param {String} name 圈子名
	 * @param {String} description 描述
	 * @return {Array}
	 * {  
	 * 　　msg: &#x27;group created&#x27;,  
	 * 　　id: group.id  
	 * }
	 */
	app.post(&#x27;/api/groups/create&#x27;, function(req, res, next){
		var user = req.user;
		if (!user) return next(errors[21301]);
		if (!req.body[&#x27;name&#x27;] || !req.body[&#x27;description&#x27;]) {
			return next(errors[10008]);
		}
		Group.forge({name: req.body[&#x27;name&#x27;]})
			.fetch()
			.then(function (group) {
				if (group) {
					return next(errors[20506]);
				}
				return Group.forge(_.extend({
					ownerid: user.id
				}, req.body)).save();
			}).then(function (group) {
				next({
					msg: &#x27;group created&#x27;,
					id: group.id
				});
			});
	});

	/**
	 * post /api/groups/join
	 * @method 加入圈子
	 * @param {Number} groupid 圈子id
	 * @return {Array} {  
	 * 　　msg: &#x27;join group success&#x27;  
	 * }
	 */
	app.post(&#x27;/api/groups/join&#x27;, function(req, res, next){
		var user = req.user;
		if(!user) return next(errors[21301]);
		return GroupMember.forge({
			&#x27;userid&#x27;: user.id,
			&#x27;groupid&#x27;: req.body[&#x27;groupid&#x27;]
		}).fetch()
			.then(function(groupMember){
				if(groupMember){
					return next(errors[20506]);
				}
				return GroupMember.forge({
					&#x27;userid&#x27;: user.id,
					&#x27;groupid&#x27;: req.body[&#x27;groupid&#x27;]
				}).save()
					.then(function(groupMember){
						next({
							msg: &#x27;join group success&#x27;
						});
					});
			});
	});

	/**
	 * post /api/groups/quit
	 * @method 退出圈子
	 * @param {Number} groupid 圈子id
	 * @return {Array} {  
	 * 　　msg: &#x27;quit group success&#x27;  
	 * }
	 */
	app.post(&#x27;/api/groups/quit&#x27;, function(req, res, next){
		var user = req.user;
		if(!user) return next(errors[21301]);
		return GroupMember.forge({
			&#x27;userid&#x27;: user.id,
			&#x27;groupid&#x27;: req.body[&#x27;groupid&#x27;]
		}).fetch()
			.then(function(groupMember){
				if(!groupMember){
					return next(errors[40001]);
				}
				return groupMember.destroy()
					.then(function(){
						next({
							msg: &#x27;quit group success&#x27;
						});
					});
			});
	});
};

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
